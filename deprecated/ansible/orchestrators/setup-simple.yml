---
# SIMPLE INCREMENTAL SETUP - NO LOCK FILES
# Uses Ansible's built-in idempotency and state detection

- name: "ğŸš€ Simple Incremental Platform Setup"
  hosts: localhost
  gather_facts: yes

  tasks:
    - name: "ğŸ·ï¸  Simple Setup Philosophy"
      debug:
        msg: |
          SIMPLE INCREMENTAL SETUP
          =======================

          Philosophy: Trust Ansible's idempotency, not lock files

          How it works:
          â€¢ Each component checks actual system state
          â€¢ Only runs if state doesn't match desired state
          â€¢ Ansible's changed/ok status shows what happened
          â€¢ No external state files or locks

    - name: "ğŸ“‹ Component 1: mkcert Binary Installation"
      include_tasks: "../components/01-mkcert-binary-tasks.yml"
      vars:
        mkcert_version: "v1.4.4"
        mkcert_url: "https://github.com/FiloSottile/mkcert/releases/download/{{ mkcert_version }}/mkcert-{{ mkcert_version }}-linux-amd64"
        mkcert_binary_path: "/usr/local/bin/mkcert"
        temp_download_path: "/tmp/mkcert-download"

    - name: "ğŸ“‹ Component 2: Windows CA Trust Installation"
      include_tasks: "../components/02-windows-ca-trust-tasks.yml"

    - name: "ğŸ“‹ Component 3: Certificate File Management"
      include_tasks: "../components/03-certificate-file-management-tasks.yml"

    - name: "ğŸ“‹ Component 4: Traefik Platform Deployment"
      include_tasks: "../components/04-traefik-platform-deployment-tasks.yml"

    - name: "ğŸ“‹ Component 5: Docker Registry Deployment"
      include_tasks: "../components/05-docker-registry-deployment-tasks.yml"

    - name: "ğŸ“‹ Component 6: Airflow Platform Deployment"
      include_tasks: "../components/06-airflow-platform-deployment-tasks.yml"
      when: component_only is not defined or component_only == "06-airflow-platform-deployment-tasks.yml"

    - name: "ğŸ‰ Simple Setup Complete"
      debug:
        msg: |
          SIMPLE SETUP COMPLETE âœ…

          All components processed using Ansible's built-in idempotency.

          What happened:
          â€¢ Each component checked actual system state
          â€¢ Only made changes if needed
          â€¢ Ansible's task status (ok/changed) shows the truth

          Philosophy: The system state IS the truth, not lock files.
