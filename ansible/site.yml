---
# Main orchestration playbook for platform setup
# Attempts full automation, fails gracefully for admin tasks

- name: "üîç Detect Environment and Permissions"
  hosts: localhost
  gather_facts: yes
  become: no
  vars:
    ansible_become_pass: "{{ ansible_sudo_pass | default(omit) }}"
  tasks:
    - name: Display setup banner
      debug:
        msg: |
          üöÄ Starting Astronomer Airflow Platform Setup

          Strategy: Try to automate everything, fail gracefully
          - ‚úÖ Local admins: Full automation
          - ‚ö†Ô∏è  Non-admins: Clear guidance for manual steps

          Platform Components:
          - Windows prerequisites (mkcert, hosts, Docker Desktop)
          - WSL2 environment setup
          - Certificate management
          - Traefik reverse proxy
          - Docker container registry
          - End-to-end validation

    - name: Check if running in WSL2
      shell: uname -r | grep -i microsoft
      register: wsl2_check
      failed_when: false
      changed_when: false

    - name: Verify WSL2 environment
      fail:
        msg: |
          ‚ùå This must be run from within WSL2

          Please:
          1. Open WSL2 terminal
          2. cd to this repository
          3. Run: ansible-playbook -i inventory/local-dev.ini site.yml
      when: wsl2_check.rc != 0

    - name: Check Windows WinRM accessibility
      uri:
        url: "http://127.0.0.1:5985/wsman"
        method: GET
        timeout: 5
      register: winrm_check
      failed_when: false
      changed_when: false

    - name: Set Windows accessibility based on WinRM availability
      set_fact:
        windows_accessible: "{{ winrm_check.status is defined and winrm_check.status in [200, 401, 500] }}"

    - name: Set execution strategy
      set_fact:
        windows_available: "{{ windows_accessible }}"
        execution_mode: "{{ 'cross-platform' if windows_accessible else 'wsl2-only' }}"

    - name: Display execution mode
      debug:
        msg: |
          üöÄ Execution Mode: {{ execution_mode }}
          ü™ü Windows Host: {{ 'Available' if windows_available else 'WSL2-only (requires Windows prerequisites)' }}

    - name: Windows prerequisites required
      pause:
        prompt: |

          ‚ö†Ô∏è  Windows Prerequisites Required!

          Since WinRM is not available, you need to run Windows setup manually.
          This will handle:
            ‚Ä¢ mkcert installation
            ‚Ä¢ Certificate generation
            ‚Ä¢ Hosts file entries (registry.localhost, traefik.localhost, airflow.localhost)
            ‚Ä¢ Windows CA trust store

          Open Windows PowerShell **AS ADMINISTRATOR** and run:

            cd \\wsl$\Ubuntu\home\{{ ansible_env.USER }}\repos\airflow-data-platform
            .\scripts\win-prereqs.ps1

          OR from WSL2 terminal (separate tab):

            cd /home/{{ ansible_env.USER }}/repos/airflow-data-platform
            powershell.exe -Command "Start-Process powershell -Verb RunAs -ArgumentList '-File scripts/win-prereqs.ps1'"

          ‚ö†Ô∏è  IMPORTANT: Administrator privileges are required for:
            ‚Ä¢ Adding entries to Windows hosts file
            ‚Ä¢ Installing certificates in system trust store
            ‚Ä¢ Docker Desktop proxy configuration

          This script will:
            1. Check what's already installed
            2. Skip things that exist
            3. Prompt for admin if needed for hosts file
            4. Show exactly what was done

          After running the script, press Enter here to continue...
      when: not windows_available

- name: "ü™ü Windows Prerequisites and Setup"
  import_playbook: validate-windows.yml
  when: windows_available | default(false)

- name: "üêß WSL2 Environment Setup"
  import_playbook: setup-wsl2.yml

- name: "‚úÖ End-to-End Validation"
  import_playbook: validate-all.yml
