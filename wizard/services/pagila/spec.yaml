service: pagila
version: 1.0
description: "Pagila sample database for PostgreSQL"
requires:
  - db.postgres
provides:
  - sample.pagila

steps:
  - id: pagila_repo_url
    type: string
    prompt: "Pagila repository URL:"
    state_key: services.pagila.repo_url
    default_from: services.pagila.repo_url
    default_value: https://github.com/Troubladore/pagila.git
    validator: pagila.validate_git_url
    next: pagila_branch

  - id: pagila_branch
    type: string
    prompt: "Pagila repository branch (leave empty for default):"
    state_key: services.pagila.branch
    default_from: services.pagila.branch
    default_value: ""
    next: pagila_postgres_image

  - id: pagila_postgres_image
    type: string
    prompt: "PostgreSQL Docker image for Pagila container:"
    state_key: services.pagila.postgres_image
    default_from: services.base_platform.postgres.image
    default_value: postgres:17.5-alpine
    validator: pagila.validate_postgres_image_url
    next: pagila_save

  - id: pagila_save
    type: action
    action: pagila.save_config
    next: pagila_install

  - id: pagila_install
    type: action
    action: pagila.install_pagila
    next: pagila_test_prebuilt

  - id: pagila_test_prebuilt
    type: boolean
    state_key: services.pagila.test_containers.pagila_test.use_prebuilt
    prompt: "Will you use a prebuilt pagila-test image with packages already installed?"
    default_from: services.pagila.test_containers.pagila_test.use_prebuilt
    default_value: false
    next: pagila_test_image

  - id: pagila_test_image
    type: string
    state_key: services.pagila.test_containers.pagila_test.image
    prompt: "Enter Docker image for pagila-test (e.g., alpine:latest or mycompany/pagila-test:latest for prebuilt):"
    default_from: services.pagila.test_containers.pagila_test.image
    default_value: "alpine:latest"
    validator: pagila.validate_postgres_image_url
    next: pagila_save_test_config

  - id: pagila_save_test_config
    type: action
    action: pagila.save_pagila_test_config
    next: pagila_verify_connection

  - id: pagila_verify_connection
    type: action
    action: pagila.verify_pagila_connection
    next: finish
