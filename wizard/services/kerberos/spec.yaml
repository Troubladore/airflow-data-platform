service: kerberos
version: "1.0"
description: "Kerberos authentication service setup"

provides:
  - kerberos

requires: []

steps:
  - id: detect_kerberos_action
    type: action
    action: kerberos.detect_configuration
    next: display_kerberos_header

  - id: display_kerberos_header
    type: action
    action: kerberos.display_kerberos_header
    next: domain_input

  - id: domain_input
    type: string
    state_key: services.kerberos.domain
    default_from: services.kerberos.domain
    prompt: "Enter Kerberos domain (e.g., COMPANY.COM):"
    validator: kerberos.validate_domain
    next: use_prebuilt_input

  - id: use_prebuilt_input
    type: boolean
    state_key: services.kerberos.use_prebuilt
    default_from: services.kerberos.use_prebuilt
    prompt: "Will you use a prebuilt image with Kerberos packages already installed?"
    default_value: false
    next: image_input

  - id: image_input
    type: string
    state_key: services.kerberos.image
    default_from: services.kerberos.image
    prompt: "Enter Docker image for Kerberos (e.g., ubuntu:22.04 or mykerberos-image for prebuilt):"
    default_value: "ubuntu:22.04"
    validator: kerberos.validate_image_url
    next: test_kerberos_action

  - id: test_kerberos_action
    type: action
    action: kerberos.test_kerberos
    next: save_config_action

  - id: save_config_action
    type: action
    action: kerberos.save_config
    next: start_service_action

  - id: start_service_action
    type: action
    action: kerberos.start_service
    next: sql_server_test_prompt

  - id: sql_server_test_prompt
    type: boolean
    state_key: services.kerberos.test_sql_server
    prompt: "Do you have a SQL Server instance to test Kerberos authentication against?"
    default_value: false
    next:
      when_value:
        true: sql_server_fqdn_input
        false: postgres_test_prompt

  - id: sql_server_fqdn_input
    type: string
    state_key: services.kerberos.sql_server_fqdn
    prompt: "Enter SQL Server FQDN (e.g., sqlserver.company.com):"
    next: display_sql_test_header

  - id: display_sql_test_header
    type: action
    action: kerberos.display_sql_test_header
    next: sql_server_test_action

  - id: sql_server_test_action
    type: action
    action: kerberos.test_sql_server_connection
    next: postgres_test_prompt

  - id: postgres_test_prompt
    type: boolean
    state_key: services.kerberos.test_postgres
    prompt: "Do you have a PostgreSQL instance to test Kerberos authentication against?"
    default_value: false
    next:
      when_value:
        true: postgres_fqdn_input
        false: complete_section

  - id: postgres_fqdn_input
    type: string
    state_key: services.kerberos.postgres_fqdn
    prompt: "Enter PostgreSQL FQDN (e.g., postgres.company.com):"
    next: display_postgres_test_header

  - id: display_postgres_test_header
    type: action
    action: kerberos.display_postgres_test_header
    next: postgres_test_action

  - id: postgres_test_action
    type: action
    action: kerberos.test_postgres_connection
    next: complete_section

  - id: complete_section
    type: action
    action: kerberos.complete_configuration
    next: finish
