service: base_platform
version: 1.0
description: "PostgreSQL database configuration"
requires: []
provides:
  - db.postgres

steps:
  - id: migrate_legacy_config
    type: action
    action: base_platform.migrate_legacy_postgres_config
    next: create_platform_network

  - id: create_platform_network
    type: action
    action: base_platform.create_platform_network
    next: display_base_platform_header

  - id: display_base_platform_header
    type: action
    action: base_platform.display_base_platform_header
    next: check_existing_base_platform

  - id: check_existing_base_platform
    type: action
    action: base_platform.check_and_prompt_reinstall_base_platform
    next: skip_install_check

  - id: skip_install_check
    type: conditional
    condition: services.base_platform.skip_install
    when_true: health_check
    when_false: display_test_containers_header

  - id: display_test_containers_header
    type: action
    action: base_platform.display_test_containers_header
    next: postgres_test_prebuilt

  - id: postgres_test_prebuilt
    type: boolean
    state_key: services.base_platform.test_containers.postgres_test.use_prebuilt
    prompt: "Will you use a prebuilt postgres-test image with packages already installed?"
    default_from: services.base_platform.test_containers.postgres_test.use_prebuilt
    default_value: false
    next: postgres_test_image

  - id: postgres_test_image
    type: string
    state_key: services.base_platform.test_containers.postgres_test.image
    prompt: "Enter Docker image for postgres-test (e.g., alpine:latest or mycompany/postgres-test:latest for prebuilt):"
    default_from: services.base_platform.test_containers.postgres_test.image
    default_value: "alpine:latest"
    validator: base_platform.validate_image_url
    next: sqlcmd_test_prebuilt

  - id: sqlcmd_test_prebuilt
    type: boolean
    state_key: services.base_platform.test_containers.sqlcmd_test.use_prebuilt
    prompt: "Will you use a prebuilt sqlcmd-test image with packages already installed?"
    default_from: services.base_platform.test_containers.sqlcmd_test.use_prebuilt
    default_value: false
    next: sqlcmd_test_image

  - id: sqlcmd_test_image
    type: string
    state_key: services.base_platform.test_containers.sqlcmd_test.image
    prompt: "Enter Docker image for sqlcmd-test (e.g., alpine:latest or mycompany/sqlcmd-test:latest for prebuilt):"
    default_from: services.base_platform.test_containers.sqlcmd_test.image
    default_value: "alpine:latest"
    validator: base_platform.validate_image_url
    next: save_test_config

  - id: save_test_config
    type: action
    action: base_platform.save_test_container_config
    next: build_test_containers

  - id: build_test_containers
    type: action
    action: base_platform.build_test_containers
    next: start_test_containers

  - id: start_test_containers
    type: action
    action: base_platform.start_test_containers
    next: display_platform_database_header

  - id: display_platform_database_header
    type: action
    action: base_platform.display_platform_database_header
    next: postgres_image

  - id: postgres_image
    type: string
    prompt: "PostgreSQL Docker image (used by all services)"
    state_key: services.base_platform.postgres.image
    default_from: services.base_platform.postgres.image
    default_value: postgres:17.5-alpine
    validator: base_platform.validate_image_url
    next: postgres_prebuilt

  - id: postgres_prebuilt
    type: boolean
    prompt: "Use prebuilt PostgreSQL image?"
    state_key: services.base_platform.postgres.use_prebuilt
    default_from: services.base_platform.postgres.use_prebuilt
    default_value: false
    next: postgres_auth

  - id: postgres_auth
    type: boolean
    prompt: "Require password for PostgreSQL database?"
    state_key: services.base_platform.postgres.require_password
    default_from: services.base_platform.postgres.require_password
    default_value: true
    next:
      when_value:
        true: postgres_password
        false: postgres_port

  - id: postgres_password
    type: string
    prompt: "PostgreSQL password:"
    state_key: services.base_platform.postgres.password
    default_value: changeme
    next: postgres_port

  - id: postgres_port
    type: integer
    prompt: "PostgreSQL port"
    state_key: services.base_platform.postgres.port
    default_value: 5432
    validator: base_platform.validate_port
    next: postgres_save

  - id: postgres_save
    type: action
    action: base_platform.save_config
    next: postgres_pull_image

  - id: postgres_pull_image
    type: action
    action: base_platform.pull_image
    next: postgres_start

  - id: postgres_start
    type: action
    action: base_platform.start_service
    next: finish
